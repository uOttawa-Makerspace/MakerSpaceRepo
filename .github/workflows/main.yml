name: CI

on:
  push:
    branches: [master, staging]
  pull_request:
    branches: [master, staging]
  workflow_dispatch:

env:
  RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}
  RAILS_ENV: test

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          PGDATA: /dev/shm/pgdata
        ports: ["5432:5432"]
        options: >-
          --health-cmd pg_isready
          --health-interval 5s
          --health-timeout 3s
          --health-retries 3
          --shm-size=512mb

    steps:
      - name: Configure PostgreSQL for speed
        run: |
          PGPASSWORD=postgres psql -h localhost -U postgres <<EOF
          ALTER SYSTEM SET fsync = off;
          ALTER SYSTEM SET synchronous_commit = off;
          ALTER SYSTEM SET full_page_writes = off;
          ALTER SYSTEM SET shared_buffers = '256MB';
          SELECT pg_reload_conf();
          EOF

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup ImageMagick
        uses: mfinelli/setup-imagemagick@v7
        with:
          cache: true

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "24.12.0"
          cache: "yarn"

      - name: Install Node dependencies
        run: yarn install --frozen-lockfile --prefer-offline

      - name: Cache SSL certificates
        id: cache-certs
        uses: actions/cache@v4
        with:
          path: certs
          key: ssl-certs-v2

      - name: Setup SSL certificates
        run: |
          mkdir -p certs
          if [ ! -f certs/saml.crt ]; then
            openssl req -x509 -newkey rsa:2048 -keyout certs/saml.key -out certs/saml.crt -days 365 -nodes -subj "/C=CA/ST=Ontario/L=Ottawa/O=uOttawa/OU=Richard L'AbbÃ© Makerspace/CN=makerepo.com/emailAddress=ci@makerepo.com"
          fi

      - name: Create Credentials File
        run: echo '${{ secrets.CREDENTIALS_JSON }}' > config/makerepo-1632742c49cc.json

      - name: Prepare Database
        run: bin/rails db:test:prepare

      - name: Run RSpec
        run: bundle exec rspec

  security:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Install security tools
        run: gem install brakeman bundler-audit ruby_audit

      - name: Run Security Audit
        run: |
          chmod +x scripts/security_audit.sh
          ./scripts/security_audit.sh || true

  deploy:
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/staging')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Deploy to Staging
        if: github.ref == 'refs/heads/staging'
        env:
          DEPLOY_ENC_KEY: ${{ secrets.DEPLOY_ENC_KEY }}
        run: |
          openssl enc -d -aes-256-cbc -md sha512 -salt -in config/deploy_id_ed25519_staging_enc -out /tmp/deploy_key -k $DEPLOY_ENC_KEY -a -pbkdf2
          chmod 600 /tmp/deploy_key
          eval "$(ssh-agent -s)"
          ssh-add /tmp/deploy_key
          bundle exec cap staging deploy

      - name: Deploy to Production
        if: github.ref == 'refs/heads/master'
        env:
          DEPLOY_ENC_KEY: ${{ secrets.DEPLOY_ENC_KEY }}
        run: |
          openssl enc -d -aes-256-cbc -md sha512 -salt -in config/deploy_id_ed25519_prod_enc -out /tmp/deploy_key -k $DEPLOY_ENC_KEY -a -pbkdf2
          chmod 600 /tmp/deploy_key
          eval "$(ssh-agent -s)"
          ssh-add /tmp/deploy_key
          bundle exec cap production deploy
