<% provide :title, "Job Orders Settings" %>

<section class="container">
  <h2 class="fw-bold text-center my-3">Job Orders Settings</h2>

  <p class="text-muted text-center">
    <b>Job Types</b> define the main service categories (like 3D printing or laser cutting). 
    Each type contains <b>Service Groups</b> that specify materials (like PLA or resin), 
    and each group offers individual <b>Services</b> with quality/color options and pricing. 
    <b>Job Options</b> are add-ons that can apply to multiple job types (like expedited service). <b>Input Required, Optional Input, No Input</b> specify whether an "Other" option with a textbox is present for the user (as in, the user must enter text, the user can enter text, or there is no input box).
  </p>

  <div class="my-3 text-center">
    <%= link_to 'Back to Admin Page', admin_job_orders_path, class: 'btn btn-outline-primary mb-1' %>
    <%= link_to 'Add New Job Type', new_admin_job_type_path, class: 'btn btn-success mb-1' %>
  </div>

  <% @job_types.each do |type| %>
    <div class="card shadow-sm overflow-hidden mb-4">
      <div class="card-header bg-light p-3">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h4 class="fw-bold mb-1"><%= type.name %></h4>
            <p class="mb-0 text-muted"><%= type.comments.present? ? sanitize(type.comments) : 'No description provided' %></p>
          </div>
          <div class="d-flex align-items-center gap-3">
            <strong class="fs-5"><%= number_to_currency(type.service_fee) %></strong>
            <%= link_to 'Edit', edit_admin_job_type_path(type.id), class: 'btn btn-sm btn-primary' %>
            <%= link_to 'Add Service Group', new_admin_job_service_group_path(job_type_id: type.id), class: 'btn btn-sm btn-success' %>
          </div>
        </div>
      </div>

      <div class="card-body p-0">
        <div class="accordion" id="accordion-<%= type.id %>">
          <% @service_groups.where(job_type_id: type.id).find_each do |service_group| %>
            <div class="accordion-item">
              <h2 class="accordion-header" id="heading-<%= service_group.id %>">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-<%= service_group.id %>" aria-expanded="false" aria-controls="collapse-<%= service_group.id %>">
                  <div class="d-flex w-100 justify-content-between align-items-center pe-3">
                    <span class="fw-bold"><%= service_group.name %></span>
                    <div class="d-flex gap-3">
                      <span class="badge bg-<%= if service_group.text_field_false?
'danger'
else
(service_group.text_field_true? ? 'success' : 'warning')
end %>" title="Text Input Required">
                        <%= if service_group.text_field_false?
'No Input'
else
(service_group.text_field_true? ? 'Input Required' : 'Optional Input')
end %>
                      </span>
                    </div>
                  </div>
                </button>
              </h2>
              <div id="collapse-<%= service_group.id %>" class="accordion-collapse collapse" aria-labelledby="heading-<%= service_group.id %>" data-bs-parent="#accordion-<%= type.id %>">
                <div class="accordion-body">
                  <p><%= service_group.description.presence || 'No description provided' %></p>

                  <!-- Services Section -->
                  <div class="mt-4">
                    <h5 class="mb-3">Services</h5>
                    <div class="accordion service-accordion" id="services-accordion-<%= service_group.id %>">
                      <% @services.where(job_service_group_id: service_group.id).find_each do |service| %>
                        <div class="accordion-item border-0 mb-2">
                          <h3 class="accordion-header" id="service-heading-<%= service.id %>">
                            <button class="accordion-button collapsed bg-light-subtle py-2" type="button" data-bs-toggle="collapse" data-bs-target="#service-collapse-<%= service.id %>" aria-expanded="false" aria-controls="service-collapse-<%= service.id %>">
                              <div class="d-flex w-100 align-items-center">
                                <span class="fw-semibold me-3"><%= service.name.presence || 'Unnamed Service' %></span>
                                <span class="badge bg-<%= service.required? ? 'danger' : 'warning' %> me-2">
                                  <%= service.required? ? 'Required' : 'Optional' %>
                                </span>
                              </div>
                            </button>
                          </h3>
                          <div id="service-collapse-<%= service.id %>" class="accordion-collapse collapse" aria-labelledby="service-heading-<%= service.id %>" data-bs-parent="#services-accordion-<%= service_group.id %>">
                            <div class="accordion-body bg-light-subtle rounded-bottom">
                              <div class="row">
                                <div class="col-md-6">
                                  <p class="mb-3"><%= service.description.presence || 'No description provided' %></p>
                                </div>
                                <div class="col-md-6">
                                  <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>Internal Pricing:</span>
                                    <div class="d-flex align-items-center">
                                      <strong><%= number_to_currency(service.internal_price) %></strong>
                                      <% if service.unit.present? %>
                                        <span class="ms-1 text-muted">/ <%= service.unit %></span>
                                      <% end %>
                                    </div>
                                  </div>
                                  <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span>External Pricing:</span>
                                    <div class="d-flex align-items-center">
                                      <strong><%= number_to_currency(service.external_price) %></strong>
                                      <% if service.unit.present? %>
                                        <span class="ms-1 text-muted">/ <%= service.unit %></span>
                                      <% end %>
                                    </div>
                                  </div>
                                </div>
                              </div>
                              <div class="d-flex gap-2">
                                <%= link_to 'Edit', edit_admin_job_service_path(service), class: 'btn btn-sm btn-outline-primary' %>
                                <%= button_to 'Delete', admin_job_service_path(service), method: :delete, class: 'btn btn-sm btn-outline-danger', form: { data: { turbo_confirm: 'Are you sure?' } } %>
                              </div>
                            </div>
                          </div>
                        </div>
                      <% end %>
                      <% if !@services.where(job_service_group_id: service_group.id).present? %>
                        <span class="text-muted">None yet</span>
                      <% end %>
                    </div>

                    <%= link_to 'Add New Service', new_admin_job_service_path(job_service_group_id: service_group.id), class: 'btn btn-sm btn-success mt-3' %>
                  </div>
                  <!-- End Services Section -->

                  <div class="d-flex gap-2 mt-3">
                    <%= link_to 'Edit Group', edit_admin_job_service_group_path(service_group.id), class: 'btn btn-sm btn-primary' %>
                    <%= button_to 'Delete Group', admin_job_service_group_path(service_group.id), method: :delete, class: 'btn btn-sm btn-danger', form: { data: { turbo_confirm: 'Are you sure?' } } %>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <hr class="mt-2 mb-4">

  <div class="card shadow-sm">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <h2 class="h4 mb-0">Job Options</h2>
      <%= link_to 'New Option', new_admin_job_option_path, class: 'btn btn-primary' %>
    </div>

    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0 notDataTable">
          <thead class="table-light">
            <tr>
              <th class="align-middle">Name</th>
              <th class="align-middle">Description</th>
              <th class="align-middle">Applicable Job Types</th>
              <th class="align-middle text-end">Fee</th>
              <th class="align-middle text-center">Files Required</th>
              <th class="align-middle text-center">Applies to All Tasks</th>
              <th class="align-middle text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @options.each do |option| %>
              <tr>
                <td class="align-middle">
                  <strong><%= option.name.presence || 'Unnamed Option' %></strong>
                </td>
                <td class="align-middle">
                  <%= sanitize option.description.presence || 'No description' %>
                </td>
                <td class="align-middle">
                  <% if option.job_types.any? %>
                    <div class="d-flex flex-wrap gap-1">
                      <% option.job_types.each do |jt| %>
                        <span class="badge bg-primary bg-opacity-10 text-primary">
                          <%= jt.name %>
                        </span>
                      <% end %>
                    </div>
                  <% else %>
                    <span class="text-muted">Not assigned</span>
                  <% end %>
                </td>
                <td class="align-middle text-end">
                  <%= number_to_currency(option.fee) %>
                </td>
                <td class="align-middle text-center">
                  <span class="badge bg-<%= option.need_files ? 'danger' : 'success' %> bg-opacity-10 text-<%= option.need_files ? 'danger' : 'success' %>">
                    <%= option.need_files ? 'Yes' : 'No' %>
                  </span>
                </td>
                <td class="align-middle text-center">
                  <span class="badge bg-<%= option.is_job_wide ? 'danger' : 'success' %> bg-opacity-10 text-<%= option.is_job_wide ? 'danger' : 'success' %>">
                    <%= option.is_job_wide ? 'Yes' : 'No' %>
                  </span>
                </td>
                <td class="align-middle text-center">
                  <div class="d-flex gap-2 justify-content-center">
                    <%= link_to 'Edit', edit_admin_job_option_path(option), class: 'btn btn-sm btn-outline-primary' %>
                    <%= button_to 'Delete', admin_job_option_path(option), 
                        method: :delete, 
                        class: 'btn btn-sm btn-outline-danger',
                        form: { data: { turbo_confirm: 'Are you sure you want to delete this option?' } } %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>

    <% if @options.empty? %>
      <div class="card-footer text-center text-muted py-4">
        No job options found.
      </div>
    <% end %>
  </div>
</section>

<style>
  .accordion-button:not(.collapsed) {
    background-color: rgba(0, 0, 0, 0.03);
    box-shadow: none;
  }

  .accordion-body {
    padding: 1.25rem;
  }

  .service-accordion .accordion-button {
    padding: 0.75rem 1.25rem;
    font-size: 0.9rem;
    background-color: #f8f9fa;
  }

  .service-accordion .accordion-body {
    background-color: #f8f9fa;
    padding: 1rem 1.25rem;
  }

  .service-accordion .accordion-item {
    border-radius: 0.375rem !important;
    overflow: hidden;
    margin-bottom: 0.5rem;
  }

  .badge {
    font-size: 0.75rem;
    font-weight: 500;
  }

  .bg-light-subtle {
    background-color: #f8f9fa;
  }

  .table th {
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    color: #6c757d;
  }

  .table td {
    vertical-align: middle;
  }
</style>