<div class="card mb-3">
  <div class="d-flex justify-content-between align-items-center card-header">
    <strong><%= t("job_orders.order.timeline") %></strong>
  </div>
  <div class="card-body">
    <% completed_status_ids = jo.job_order_statuses.map(&:job_status_id) %>
    <% status_by_id = jo.job_order_statuses.index_by(&:job_status_id) %>
    <% current_status = jo.job_order_statuses.last&.job_status %>
    <% current_status_id = current_status&.id %>

    <% all_statuses = [
      JobStatus::DRAFT,
      JobStatus::STAFF_APPROVAL,
      JobStatus::USER_APPROVAL,
      JobStatus::SENT_REMINDER,
      JobStatus::WAITING_PROCESSED,
      JobStatus::BEING_PROCESSED,
      JobStatus::COMPLETED,
      JobStatus::PAID,
      JobStatus::PICKED_UP,
      JobStatus::DECLINED
    ].compact.reverse %>

    <% filtered_statuses = all_statuses.reject do |status|
      [JobStatus::DECLINED, JobStatus::SENT_REMINDER].include?(status) && !completed_status_ids.include?(status.id)
    end %>

    <% current_index = filtered_statuses.find_index(current_status) %>

    <ul class="list-group list-group-flush">
      <% filtered_statuses.each_with_index do |status, index| %>
        <% jos = status_by_id[status.id] %>
        <% is_completed = completed_status_ids.include?(status.id) && index > current_index %>
        <% is_current = status == current_status %>
        <% is_future = index < current_index && !is_current %>
        <% is_cancelled = current_status == JobStatus::DECLINED && index < current_index %>

        <li class="list-group-item <%= 'bg-light border-primary' if is_current %>" style="<%= is_completed || is_future ? 'opacity: 0.5;' : '' %>">
          <div class="d-flex justify-content-between align-items-start">
            <div class="d-flex align-items-center">
              <% if is_completed %>
                <%= fa_icon :check, class: 'me-2 text-success' %>
              <% elsif is_current %>
                <%= fa_icon :dot_circle, class: 'me-2 text-primary' %>
              <% else %>
                <%= fa_icon :circle, class: 'me-2 text-muted' %>
              <% end %>

              <div>
                <% name_class = if is_current
'fw-bold text-primary'
else
is_cancelled ? 'text-decoration-line-through text-muted' : ''
end %>
                <strong class="<%= name_class %>"><%= status.t_name %></strong>
                <p class="mb-0 small <%= is_cancelled ? 'text-decoration-line-through text-muted' : '' %>">
                  <%= status.t_description %>
                </p>
              </div>
            </div>
            <% if jos %>
              <small class="text-muted"><%= l(jos.created_at, format: :long) %></small>
            <% end %>
          </div>

          <%# Special UI for certain current statuses - shown inside the li if it's the current one %>
          <% if is_current && [JobStatus::USER_APPROVAL, JobStatus::SENT_REMINDER, JobStatus::COMPLETED].include?(status) %>
            <div class="alert alert-warning mt-3">
              <p><b><%= t('job_orders.public_page.action_required', blank: status == JobStatus::COMPLETED ? t('job_orders.public_page.total_invoice') : t('job_orders.public_page.total_quote')) %> <%= number_to_currency(jo.total_price) %></b></p>
              <% if current_user.id == jo.user_id %>
                <div class="d-flex justify-content-start flex-wrap">
                  <% if status == JobStatus::COMPLETED %>
                    <%= link_to t('job_orders.public_page.pay_online'), pay_job_orders_path(token: Rails.application.message_verifier(:job_order_id).generate(jo.id)), class: 'btn btn-primary me-2 mb-2' %>
                    <a href="https://en.wiki.makerepo.com/wiki/How_to_pay_for_an_Order" class="btn btn-primary mb-2"><%= t('job_orders.public_page.pay_in_store') %></a>
                  <% else %>
                    <%= form_tag job_order_user_approval_path(job_order_id: jo.id, approved: true), method: :patch, class: 'me-2 mb-2' do %>
                      <%= submit_tag t('job_orders.public_page.approve'), class: 'btn btn-primary' %>
                    <% end %>
                    <%= form_tag job_order_user_approval_path(job_order_id: jo.id, approved: false), method: :patch, class: 'mb-2' do %>
                      <%= submit_tag t('job_orders.public_page.deny'), class: 'btn btn-danger' %>
                    <% end %>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>
        </li>
      <% end %>
    </ul>
  </div>
</div>
