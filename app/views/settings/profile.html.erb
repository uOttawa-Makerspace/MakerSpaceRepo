<% provide(:title, 'Settings') %>

<div class="cert-card p-4 p-md-5">
  <h3 class="mb-2"><%= t('settings.profile.title') %></h3>
  <p class="text-muted mb-4">
    <%= t('settings.profile.public_information') %>
    <small class="d-block"><%= t('settings.profile.public_information_desc') %></small>
  </p>

  <%= form_for @user, url: user_path(@user.username), html: { class: 'needs-validation', novalidate: true }, method: :patch do |f| %>

    <!-- AVATAR SECTION -->
    <div class="mb-4 d-flex align-items-center gap-3">
      <div class="position-relative">
        <%= image_tag @user.display_avatar, class: 'rounded-circle object-fit-cover border', style: 'width: 80px; height: 80px;', alt: 'Avatar' %>
      </div>
      <div>
        <%= f.label :avatar, t('settings.profile.choose_image'), class: 'btn btn-sm btn-outline-secondary mb-1' %>
        <%= f.file_field :avatar, class: 'd-none' %>
        
        <% if @user.has_avatar? %>
          <div>
            <%= link_to t('settings.profile.delete_avatar'), remove_avatar_users_path, class: "text-danger small text-decoration-none", data: { confirm: t('settings.profile.delete_avatar_confirm') } %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- BASIC INFO -->
    <div class="mb-3">
      <%= f.label :name, t('settings.profile.full_name'), class: 'form-label' %>
      <%= f.text_field :name, class: 'form-control profile-text', autofocus: true %>
      <% if @user.errors[:name].any? %>
        <div class="text-danger small mt-1"><%= @user.errors[:name].first %></div>
      <% end %>
    </div>

    <!-- IDENTITY RADIO BUTTONS -->
    <div class="mb-4">
      <label class="form-label d-block mb-2"><%= t('users.new.form.i_am') %> <span class="text-danger">*</span></label>
      
      <div class="d-flex flex-column gap-2">
        <% identities = [
          ['undergrad', 'undergrad'], 
          ['international_undergrad', 'international_undergrad'],
          ['grad', 'grad'],
          ['international_grad', 'international_grad'],
          ['faculty_member', 'faculty_member'],
          ['community_member', 'community_member']
        ] %>

        <% identities.each do |id_val, trans_key| %>
          <div class="form-check">
            <% 
               data_attrs = ['faculty_member', 'community_member'].include?(id_val) ? { 'data-hide': '#students-only' } : { 'data-show': '#students-only' }
            %>
            <%= f.radio_button :identity, id_val, class: 'form-check-input', **data_attrs %>
            <%= f.label :identity, t("users.new.form.#{trans_key}"), class: 'form-check-label', value: id_val %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- STUDENTS ONLY SECTION -->
    <fieldset id="students-only" class="p-3 mb-4 rounded border bg-body-tertiary">
      <h6 class="text-muted text-uppercase mb-3" style="font-size: 0.8rem; letter-spacing: 1px;">Student Details</h6>
      
      <div class="mb-3">
        <%= f.label :student_id, t('users.new.form.student_id'), class: 'form-label' %>
        <%= f.text_field :student_id, { class: 'form-control', inputmode: 'numeric', autocomplete: 'off', minlength: '9', maxlength: '9', pattern: '[0-9]{9}', title: '9 digit number' } %>
      </div>

      <div class="mb-3">
        <%= f.label :faculty, t('users.new.form.faculty'), class: 'form-label' %>
        <%= f.select :faculty, [
              [t('users.new.form.arts'), 'Arts'],
              [t('users.new.form.law'), 'Law'], [t('users.new.form.education'), 'Education'],
              [t('users.new.form.engineering'), 'Engineering'], [t('users.new.form.health_sciences'), 'Health Sciences'],
              [t('users.new.form.medicine'), 'Medicine'], [t('users.new.form.science'), 'Science'],
              [t('users.new.form.social_sciences'), 'Social Sciences'], [t('users.new.form.telfer'), 'Telfer School of Management']
            ], { prompt: t('users.new.form.choose.faculty') }, { class: 'form-select profile-select' } %>
      </div>

      <div class="mb-3">
        <%= f.label :program, t('settings.profile.program'), class: 'form-label' %>
        <%= f.select :program, @programs, { prompt: t('settings.profile.choose') }, { class: 'form-select profile-select' } %>
      </div>

      <div class="mb-3">
        <%= f.label :year_of_study, t('users.new.form.year_of_study'), class: 'form-label' %>
        <%= f.select :year_of_study, (1..10).to_a.map { |n| [n, n] }, { prompt: t('users.new.form.choose.default') }, class: 'form-select profile-select' %>
      </div>
    </fieldset>

    <!-- WAIVER SECTION -->
    <% unless @user.read_and_accepted_waiver_form %>
      <div class="waiver card mb-4 border-warning">
        <div class="card-body">
          <div class="mb-3 waiver-content" style="max-height: 200px; overflow-y: auto;">
            <%= render 'users/waiver' %>
          </div>
          <div class="form-check">
            <%= f.check_box :read_and_accepted_waiver_form, class: 'form-check-input' %>
            <%= f.label :read_and_accepted_waiver_form, class: 'form-check-label' do %>
              <%= t('users.new.form.accept_waiver_html') %> <span class="text-danger">*</span>
            <% end %>
            <% @user.errors[:read_and_accepted_waiver_form].each do |err| %>
              <div class="text-danger small"><%= err %></div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <!-- LEGACY / OLD USERS SECTION -->
    <% if @user.identity == "unknown" || @user.name == "anonymous" || @user.gender == "unknown" %>
      <div id="old_users" class="alert alert-danger mb-4">
        <h5 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Action Required</h5>
        <p class="mb-3">MakerRepo has been updated. Please update your information.</p>
        <div class="mb-2">
            <%= f.label :gender, class: 'form-label' %>
            <%= f.select :gender, ['Male', 'Female', 'Other', 'Prefer not to specify'], { prompt: 'Choose...' }, class: 'form-select' %>
        </div>
      </div>
    <% end %>

    <div class="d-flex justify-content-end">
      <%= f.submit 'Save Changes', class: 'btn btn-primary px-4' %>
    </div>

  <% end %> 
</div>