<% provide :title, 'Locker dashboard' %>

<div class="text-center">
    <h1>Locker Management</h1>
    <details>
        <summary>Make new lockers</summary>
        <%= form_with controller: :lockers do |f| %>
            <div class="d-md-flex align-items-baseline">
                <span class="me-3">
                    Create new lockers ranging from
                </span>
                <div class="me-3">
                    <%= f.number_field :range_start, class: 'form-control', required: true %>
                </div>
                <span class="me-3">
                    to
                </span>
                <div class="me-3">
                    <%= f.number_field :range_end, class: 'form-control', required: true %>
                </div>
                <div class="ms-auto">
                    <%= f.submit class: 'btn btn-primary' %>
                </div>

            </div>
        <% end %>
    </details>

    <hr />

    <fieldset class="border p-3">
        <legend class="w-auto float-none">Lockers available</legend>
        <% if @lockers.blank? %>
            <p>There are no lockers on record.</p>
        <% else %>
            <table class="table table-striped" data-datatable data-page-length="25">
                <thead class="table-primary">
                    <tr>
                        <th scope="col">Locker name</th>
                        <th scope="col">Owned by</th>
                        <th scope="col">Locker expires on</th>
                        <th scope="col">Approved on</th>
                        <th scope="col">Last actioned by</th>
                        <th scope="col">Expired?</th>
                    </tr>
                </thead>
                <tbody>
                    <% @lockers.each do |locker| %>
                        <% current_rental = locker.locker_rentals.assigned.first %>
                        <tr>
                            <th scope="row">
                                <% if current_rental %>
                                    <%= link_to locker.specifier, locker_rental_path(current_rental), class: 'stretched-link' %>
                                <% else %>
                                    <%= locker.specifier %>
                                <% end %>
                            </th>
                            <td><%= current_rental&.rented_by&.username %></td>
                            <td><%= current_rental&.owned_until&.to_date&.to_fs :long %></td>
                            <td><%= current_rental&.updated_at %></td>
                            <td><%= current_rental&.decided_by&.username %></td>
                            <td>
                                <% if current_rental.present? %>
                                    <% if current_rental.expired? %>
                                        <p class="text-danger"><%= fa_icon :times %> Expired</p>
                                    <% else %>
                                        <p class="text-success"><%= fa_icon :check %> Valid</p>
                                    <% end %>
                                <% end %>
                            </td>
                        </tr>
                    <% end %>
                </tbody>
            </table>
        <% end %>
    </fieldset>

</div>
