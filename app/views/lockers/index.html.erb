<% provide :title, 'Locker dashboard' %>

<div>
    <h1 class="text-center">Locker Management</h1>
    <details class="mb-3">
        <summary>Make new lockers</summary>
        <%= form_with controller: :lockers do |f| %>
            <div class="d-md-flex align-items-baseline">
                <span class="me-3">
                    Create new lockers ranging from
                </span>
                <div class="me-3">
                    <%= f.number_field :range_start, class: 'form-control', required: true %>
                </div>
                <span class="me-3">
                    to
                </span>
                <div class="me-3">
                    <%= f.number_field :range_end, class: 'form-control', required: true %>
                </div>
                <%= f.submit class: 'btn btn-primary' %>
            </div>
        <% end %>
    </details>

    <details open>
        <summary>Configure locker options</summary>
        <%= form_with controller: :lockers, url: {action: :price}, method: :put, class: 'mb-3' do |f| %>
            <%= f.label :value, 'Link to shopify product URL', class: 'form-label' %>
            <div class="input-group">
                <%= f.text_field :value, id: 'shopifyProductLink', class: 'form-control' %>
                <%= f.button name: :name, value: :shopify_product_link, class: 'btn btn-primary' %>
            </div>
            <div class="form-text">
                <span>Currently linked with </span> <%= @locker_product_link ? link_to(@locker_product_link, @locker_product_link) : 'nothing' %>
            </div>
        <% end %>

        <% if @locker_product_info %>
            <div class="card">
                <div class="row">
                    <div class="col-md-3" style="max-height: 15em">
                        <%= image_tag @locker_product_info[:image_url], class: 'rounded-start object-fit-cover w-100 h-100' %>
                    </div>
                    <div class="col-md-9">
                        <div class="card-body">
                            <p class="card-title fs-3 fw-bold"><%= @locker_product_info[:title] %></p>
                            <p class="card-text">
                                <b>SKU</b> <code><%= @locker_product_info[:sku] %></code> <br />
                                <b>Product ID</b> <code><%= @locker_product_info[:product_id] %></code> <br />
                                <b>Variant ID</b> <code><%= @locker_product_info[:variant_id] %></code> <br />
                                <b>Received pricing</b> <code><%= @locker_product_info[:price] %> CAD</code>
                            </p>
                            <p class="card-text">
                                Last updated on <%= @locker_product_info[:updated_at].to_datetime.to_fs :long %>.
                                <%= link_to 'View product', @locker_product_link %>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        <% elsif @locker_product_link %>
            <p class="text-center text-danger fw-bold">
                Failed to load product information.
            </p>
        <% else %>
            <p class="text-center">No valid link assigned...</p>
        <% end %>
    </details>

    <hr />

    <fieldset class="border p-3">
        <legend class="w-auto float-none">Lockers available</legend>
        <% if @lockers.blank? %>
            <p>There are no lockers on record.</p>
        <% else %>
            <table class="table table-striped" data-datatable data-page-length="25">
                <thead class="table-primary">
                    <tr>
                        <th scope="col">Locker name</th>
                        <th scope="col">Owned by</th>
                        <th scope="col">Locker expires on</th>
                        <th scope="col">Approved on</th>
                        <th scope="col">Last actioned by</th>
                        <th scope="col">Expired?</th>
                    </tr>
                </thead>
                <tbody>
                    <% @lockers.each do |locker| %>
                        <% current_rental = locker.locker_rentals.find(&:active?) %>
                        <tr>
                            <th scope="row">
                                <% if current_rental %>
                                    <%= link_to locker.specifier, locker_rental_path(current_rental) %>
                                <% else %>
                                    <%= locker.specifier %>
                                <% end %>
                            </th>
                            <td><%= current_rental&.rented_by&.username %></td>
                            <td><%= current_rental&.owned_until&.to_date&.to_fs :long %></td>
                            <td><%= current_rental&.updated_at %></td>
                            <td><%= current_rental&.decided_by&.username %></td>
                            <td>
                                <% if current_rental.present? %>
                                    <% if current_rental.expired? %>
                                        <span class="text-danger"><%= fa_icon :times %> Expired</span>
                                    <% else %>
                                        <span class="text-success"><%= fa_icon :check %> Valid</span>
                                    <% end %>
                                <% end %>
                            </td>
                        </tr>
                    <% end %>
                </tbody>
            </table>
        <% end %>
    </fieldset>

</div>
