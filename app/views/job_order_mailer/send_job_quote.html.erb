<html>
<head>
  <meta name="viewport" content="width=device-width">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <style>
    @media only screen and (max-width: 620px) {
      table[class=body] h1 { font-size: 28px !important; margin-bottom: 10px !important; }
      table[class=body] p, table[class=body] ul, table[class=body] ol, table[class=body] td,
      table[class=body] span, table[class=body] a { font-size: 16px !important; }
      table[class=body] .wrapper, table[class=body] .article { padding: 10px !important; }
      table[class=body] .content { padding: 0 !important; }
      table[class=body] .container { padding: 0 !important; width: 100% !important; }
      table[class=body] .main { border-left-width: 0 !important; border-radius: 0 !important; border-right-width: 0 !important; }
      table[class=body] .btn table { width: 100% !important; }
      table[class=body] .btn a { width: 100% !important; }
      table[class=body] .img-responsive { height: auto !important; max-width: 100% !important; width: auto !important; }
    }
    @media all {
      .apple-link a { color: inherit !important; text-decoration: none !important; }
      .btn-primary a:hover { background-color: #34495e !important; border-color: #34495e !important; }
    }
  </style>
</head>
<body style="background-color: #f6f6f6; font-family: sans-serif; font-size: 14px; margin: 0; padding: 0;">
<span class="preheader" style="color: transparent; display: none;">Makerepo - Job Order Approval</span>

<table role="presentation" class="body" width="100%" bgcolor="#f6f6f6">
  <tr>
    <td>&nbsp;</td>
    <td class="container" width="580" style="display: block; max-width: 580px; padding: 10px; margin: 0 auto;">
      <div class="content" style="max-width: 580px; margin: 0 auto; padding: 10px;">

        <table role="presentation" class="main" width="100%" style="background: #ffffff; border-radius: 3px;">
          <tr>
            <td class="wrapper" style="padding: 20px;">
              <table role="presentation" width="100%">
                <tr>
                  <td>
                    <%= image_tag('ceed.png', alt: 'CEED Logo', width: 120, height: 34, style: 'display:block;') %>
                    <br>

                    <!-- FRENCH SECTION -->
                    <p>Bonjour,</p>
                    <% if @reminder %>
                      <p>Ceci est un rappel que les administrateurs ont approuvé une commande. Veuillez consulter le devis et l'approuver ou le refuser.</p>
                    <% end %>

                    <p>
                      Votre commande numéro #<%= @job_order.id %> a été approuvée. Consultez la 
                      <a href="<%= user_magic_approval_job_orders_url(token: @hash) %>">page de la commande</a> pour approuver ou refuser le devis.
                    </p>

                    <p>
                      <strong>Prix :</strong><br>
                      <% @job_order.job_tasks.each do |task| %>
                        - <%= task.title %>
                        <% if task.job_service.present? %>
                          (<%= task.job_service.name %>
                          <% if task.job_service.job_service_group.present? %>
                            - <%= task.job_service.job_service_group.name %><% end %>)
                        <% end %>

                        <% base_fee = task.job_task_quote&.price.to_f %>
                        <% task_price = task.job_task_quote&.service_price.to_f * (task.job_task_quote&.service_quantity || 0) %>
                        <% total_task_price = base_fee + task_price %>

                        :     
                        <% if total_task_price > 0 %>
                          CAD <%= number_to_currency(total_task_price) %>
                          <small>(frais de base de <%= number_to_currency(base_fee) %> plus
                            <% if task.job_task_quote&.service_quantity.present? %>
                              <%= "#{task.job_task_quote.service_quantity} #{task.job_service&.unit.presence || 'unité'}" %>
                              ×
                              <%= number_to_currency(task.job_task_quote.service_price) %><% end %>)</small>
                        <% else %>
                          Prix en attente
                        <% end %>
                        <br>

                        <% task.job_task_options.each do |opt| %>
                          &nbsp;&nbsp;• <%= opt.job_option.name %>
                          : CAD <%= number_to_currency(task.job_task_quote&.job_task_quote_options&.find_by(job_option_id: opt.job_option.id)&.price || 0) %>
                          <br>
                        <% end %>
                      <% end %>

                      <% if @job_order.job_quote_line_items.any? %>
                        <strong>Articles détaillés :</strong><br>
                        <% @job_order.job_quote_line_items.each do |item| %>
                          - <%= item.description %>: CAD <%= number_to_currency(item.price) %>
                          <br>
                        <% end %>
                      <% end %>

                      <strong>Total général :</strong> CAD <%= number_to_currency(@job_order.total_price) %>
                    </p>

                    <!-- ENGLISH SECTION -->
                    <hr style="margin: 25px 0;">

                    <p>Hello,</p>
                    <% if @reminder %>
                      <p>This is a reminder that admins have approved a Job Order. Please review the quote and approve or deny it.</p>
                    <% end %>

                    <p>
                      Your Job Order with ID #<%= @job_order.id %> has been approved. Check the 
                      <a href="<%= user_magic_approval_job_orders_url(token: @hash) %>">Job Order page</a> to approve or deny the quote.
                    </p>

                    <p>
                      <strong>Pricing:</strong><br>
                      <% @job_order.job_tasks.each do |task| %>
                        - <%= task.title %>
                        <% if task.job_service.present? %>
                          (<%= task.job_service.name %>
                          <% if task.job_service.job_service_group.present? %>
                            - <%= task.job_service.job_service_group.name %><% end %>)
                        <% end %>

                        <% base_fee = task.job_task_quote&.price.to_f %>
                        <% task_price = task.job_task_quote&.service_price.to_f * (task.job_task_quote&.service_quantity || 0) %>
                        <% total_task_price = base_fee + task_price %>

                        :     
                        <% if total_task_price > 0 %>
                          CAD <%= number_to_currency(total_task_price) %>
                          <small>(base fee of <%= number_to_currency(base_fee) %> plus
                            <% if task.job_task_quote&.service_quantity.present? %>
                              <%= "#{task.job_task_quote.service_quantity} #{task.job_service&.unit.presence || 'unit'}" %>
                              ×
                              <%= number_to_currency(task.job_task_quote.service_price) %><% end %>)</small>
                        <% else %>
                          Pending pricing
                        <% end %>
                        <br>

                        <% task.job_task_options.each do |opt| %>
                          &nbsp;&nbsp;• <%= opt.job_option.name %>
                          : CAD <%= number_to_currency(task.job_task_quote&.job_task_quote_options&.find_by(job_option_id: opt.job_option.id)&.price || 0) %>
                          <br>
                        <% end %>
                      <% end %>

                      <% if @job_order.job_quote_line_items.any? %>
                        <strong>Line items:</strong><br>
                        <% @job_order.job_quote_line_items.each do |item| %>
                          - <%= item.description %>: CAD <%= number_to_currency(item.price) %>
                          <br>
                        <% end %>
                      <% end %>

                      <strong>Grand Total:</strong> CAD <%= number_to_currency(@job_order.total_price) %>
                    </p>

                    <table role="presentation" class="btn btn-primary" width="100%">
                      <tr>
                        <td align="left" style="padding-bottom: 15px;">
                          <table role="presentation">
                            <tr>
                              <td style="border-radius: 5px; text-align: center; background-color: #e55426ff;">
                                <a href="<%= user_magic_approval_job_orders_url(token: @hash) %>" target="_blank"
                                   style="display:inline-block; padding:12px 25px; font-weight:bold; background-color:#e55426ff; color:#fff; border-radius:5px; text-decoration:none;">
                                  Voir / See order
                                </a>
                              </td>
                            </tr>
                          </table>
                        </td>
                      </tr>
                    </table>

                    <p style="font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; margin-bottom: 15px;">
                      Merci,<br>
                      Thank you,<br>
                      <b>The MakerRepo Team</b>
                    </p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
        </table>

        <div class="footer" style="margin-top: 10px; text-align: center; width: 100%;">
          <table role="presentation" width="100%">
            <tr>
              <td class="content-block" style="padding: 10px; color: #999999; font-size: 12px; text-align: center;">
                <span class="apple-link">CEED, 150 Louis Pasteur, Ottawa ON Canada K1N 6N5</span>
                <p style="margin: 0; color: #999999; font-size: 12px;">
                  Vous avez reçu ce courriel parce qu'une commande a été approuvée sur 
                  <a href="https://makerepo.com" style="color: #999999;">makerepo.com</a>.
                </p>
                <p style="margin: 0; color: #999999; font-size: 12px;">
                  You have received this email because a Job Order was approved on 
                  <a href="https://makerepo.com" style="color: #999999;">makerepo.com</a>.
                </p>
              </td>
            </tr>
          </table>
        </div>

      </div>
    </td>
    <td>&nbsp;</td>
  </tr>
</table>
</body>
</html>