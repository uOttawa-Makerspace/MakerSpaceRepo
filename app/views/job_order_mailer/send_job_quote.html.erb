<% content_for :preheader do %>
  Makerepo - Job Order Approval
<% end %>

<% content_for :team_name do %>
  The MakerRepo Team
<% end %>

<% content_for :why_received do %>
  Vous avez reçu ce courriel parce qu'une commande a été approuvée sur <a href="https://makerepo.com" style="text-decoration: underline; color: #999999; font-size: 12px; text-align: center;">makerepo.com</a>.
  <br>
  You have received this email because a Job Order was approved on <a href="https://makerepo.com" style="text-decoration: underline; color: #999999; font-size: 12px; text-align: center;">makerepo.com</a>.
<% end %>

<!-- FRENCH SECTION -->
<p style="font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; margin-bottom: 15px;">Bonjour,</p>

<% if @reminder %>
  <p style="font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; margin-bottom: 15px;">
    Ceci est un rappel que les administrateurs ont approuvé une commande. Veuillez consulter le devis et l'approuver ou le refuser.
  </p>
<% end %>

<p style="font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; margin-bottom: 15px;">
  Votre commande numéro #<%= @job_order.id %> a été approuvée. Consultez la 
  <a href="<%= user_magic_approval_job_orders_url(token: @hash) %>">page de la commande</a> pour approuver ou refuser le devis.
</p>

<p style="font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; margin-bottom: 15px;">
  <strong>Prix :</strong><br>
  <% @job_order.job_tasks.each do |task| %>
    - <%= task.title %>
    <% if task.job_service.present? %>
      (<%= task.job_service.name %>
      <% if task.job_service.job_service_group.present? %>
        - <%= task.job_service.job_service_group.name %>
      <% end %>)
    <% end %>

    <% base_fee = task.job_task_quote&.price.to_f %>
    <% task_price = task.job_task_quote&.service_price.to_f * (task.job_task_quote&.service_quantity || 0) %>
    <% total_task_price = base_fee + task_price %>

    : 
    <% if total_task_price > 0 %>
      CAD <%= number_to_currency(total_task_price) %>
      <small>(frais de base de <%= number_to_currency(base_fee) %> plus
        <% if task.job_task_quote&.service_quantity.present? %>
          <%= "#{task.job_task_quote.service_quantity || 0} #{task.job_service&.unit.presence || 'unité'}" %>
          ×
          <%= number_to_currency(task.job_task_quote.service_price || 0) %>
        <% end %>)</small>
    <% else %>
      Prix en attente
    <% end %>
    <br>

    <% task.job_task_options.each do |opt| %>
      &nbsp;&nbsp;• <%= opt.job_option.name %>
      : CAD <%= number_to_currency(task.job_task_quote&.job_task_quote_options&.find_by(job_option_id: opt.job_option.id)&.price || 0) %>
      <br>
    <% end %>
  <% end %>

  <% if @job_order.job_quote_line_items.any? %>
    <strong>Articles détaillés :</strong><br>
    <% @job_order.job_quote_line_items.each do |item| %>
      - <%= item.description %>: CAD <%= number_to_currency(item.price) %>
      <br>
    <% end %>
  <% end %>

  <strong>Total général :</strong> CAD <%= number_to_currency(@job_order.total_price) %>
</p>

<!-- ENGLISH SECTION -->
<hr style="margin: 25px 0; border: none; border-top: 1px solid #dddddd;">

<p style="font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; margin-bottom: 15px;">Hello,</p>

<% if @reminder %>
  <p style="font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; margin-bottom: 15px;">
    This is a reminder that admins have approved a Job Order. Please review the quote and approve or deny it.
  </p>
<% end %>

<p style="font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; margin-bottom: 15px;">
  Your Job Order with ID #<%= @job_order.id %> has been approved. Check the 
  <a href="<%= user_magic_approval_job_orders_url(token: @hash) %>">Job Order page</a> to approve or deny the quote.
</p>

<p style="font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; margin-bottom: 15px;">
  <strong>Pricing:</strong><br>
  <% @job_order.job_tasks.each do |task| %>
    - <%= task.title %>
    <% if task.job_service.present? %>
      (<%= task.job_service.name %>
      <% if task.job_service.job_service_group.present? %>
        - <%= task.job_service.job_service_group.name %>
      <% end %>)
    <% end %>

    <% base_fee = task.job_task_quote&.price.to_f %>
    <% task_price = task.job_task_quote&.service_price.to_f * (task.job_task_quote&.service_quantity || 0) %>
    <% total_task_price = base_fee + task_price %>

    : 
    <% if total_task_price > 0 %>
      CAD <%= number_to_currency(total_task_price) %>
      <small>(base fee of <%= number_to_currency(base_fee) %> plus
        <% if task.job_task_quote&.service_quantity.present? %>
          <%= "#{task.job_task_quote.service_quantity || 0} #{task.job_service&.unit.presence || 'unit'}" %>
          ×
          <%= number_to_currency(task.job_task_quote.service_price || 0) %>
        <% end %>)</small>
    <% else %>
      Pending pricing
    <% end %>
    <br>

    <% task.job_task_options.each do |opt| %>
      &nbsp;&nbsp;• <%= opt.job_option.name %>
      : CAD <%= number_to_currency(task.job_task_quote&.job_task_quote_options&.find_by(job_option_id: opt.job_option.id)&.price || 0) %>
      <br>
    <% end %>
  <% end %>

  <% if @job_order.job_quote_line_items.any? %>
    <strong>Line items:</strong><br>
    <% @job_order.job_quote_line_items.each do |item| %>
      - <%= item.description %>: CAD <%= number_to_currency(item.price) %>
      <br>
    <% end %>
  <% end %>

  <strong>Grand Total:</strong> CAD <%= number_to_currency(@job_order.total_price) %>
</p>

<table role="presentation" class="btn btn-primary" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; box-sizing: border-box; width: 100%;" width="100%">
  <tbody>
    <tr>
      <td align="left" style="font-family: sans-serif; font-size: 14px; vertical-align: top; padding-bottom: 15px;" valign="top">
        <table role="presentation" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: auto;">
          <tbody>
            <tr>
              <td style="font-family: sans-serif; font-size: 14px; vertical-align: top; border-radius: 5px; text-align: center; background-color: #e55426ff;" valign="top" align="center" bgcolor="#e55426ff">
                <a href="<%= user_magic_approval_job_orders_url(token: @hash) %>" target="_blank" style="border: solid 1px #e55426ff; border-radius: 5px; box-sizing: border-box; cursor: pointer; display: inline-block; font-size: 14px; font-weight: bold; margin: 0; padding: 12px 25px; text-decoration: none; background-color: #e55426ff; border-color: #e55426ff; color: #ffffff;">Voir / See Order</a>
              </td>
            </tr>
          </tbody>
        </table>
      </td>
    </tr>
  </tbody>
</table>