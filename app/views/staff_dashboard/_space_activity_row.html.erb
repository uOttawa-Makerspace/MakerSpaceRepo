<%# space_activity_row is auto set when rendered with collection: parameter %>
<%# iteration variable name depends on partial name. %>
<% user = space_activity_row %>
<tr data-user-id="<%= user.id %>" class="align-middle">
    <td>
        <%= link_to(tag.drop_username(user.name), user_url(user.username), class: "align-middle") %>
        <% if user.has_active_membership? %>
            <p class="text-success">
                <% if user.active_membership.faculty? %>
                    <%= fa_icon "cogs" %>
                    Has an Engineering Membership
                <% elsif user.student? %>
                    <%= fa_icon "university" %>
                    Has a Community Membership
                <% else %>
                    <%= fa_icon "check-circle" %>
                    Has an External Membership
                <% end %>
            </p>
        <% end %>
    </td>
    <td class="align-middle"><%= user.email %></td>
    <% unless local_assigns[:signed_out] %>
        <%# Render staff flags %>
        <td class="align-middle">
            <%= render 'staff_dashboard/flag', staff_dashboard_user: user %>
            <% if user.flagged? %>
                <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#flag_message_<%= user.id %>">See Flag</button>
            <% else %>
                None
            <% end %>
            <% if space.needs_walk_in_safety_sheet? && !user.walk_in_safety_sheets.any? %>
                <p class="text-danger"><%= fa_icon :warning %> Did not sign sheet</p>
            <% end %>
        </td>

        <td class="align-middle">
            <% user.certifications.each do |certification| %>
                <% next unless @space.ceed? || certification.training.spaces.include?( @space) %>
                <div class="cert-name" style="display:inline">
                    <div class="cert-holder" style="display:inline">
                        <%= certification.training.localized_name %>
                        <div id="cert-details" style="display:inline">
                            <%= certification.training.localized_name %> <br>
                            <%= certification.trainer.name %> <br>
                            <%= certification.updated_at.strftime('%B %d, %Y') %>
                        </div>
                        <br/>
                    </div>
                </div>
            <% end %>
        </td>
        <% if space.makerspace? %>
            <td class="printers-cell align-middle">
                <% user.printer_sessions.where(in_use: true).find_each do |printer_session| %>
                    <p class="m-0"><%= printer_session.printer.name %></p>
                <% end %>
            </td>
        <% end %>
        <td><%= user.lab_sessions.where(space: @space, created_at: 2.months.ago..DateTime.now).count %></td>
    <% end %>
    <td class="align-middle">
        <% if user.lab_sessions.second_to_last.present? %>
            <%= time_ago_in_words(user.lab_sessions.sort_by(&:sign_out_time).second_to_last&.sign_out_time) + " ago at #{user.lab_sessions.last.space.name}" %>
        <% end %>
    </td>
    <td class="align-middle dt-center">
        <% if local_assigns[:signed_out] %>
            <%= button_to fa_icon('check'), {
                controller: :staff_dashboard,
                action: :sign_in_users,
                added_users: [user.username]
            }, method: :put, class: 'btn btn-default check-button' %>
        <% else %>
            <%= button_to fa_icon('times'), {
                controller: :staff_dashboard,
                action: :sign_out_users,
                dropped_users: [user.username]
            }, method: :put, class: 'btn btn-default x-button' %>
        <% end %>
    </td>
</tr>
